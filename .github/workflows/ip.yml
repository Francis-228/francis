name: FOFA IPTV è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: "*/15 * * * *"  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30     # æœ€å¤§è¿è¡Œæ—¶é•¿é™åˆ¶
    permissions:
      contents: write       # æˆäºˆå†™å…¥ä»£ç åº“æƒé™
      issues: write         # æˆäºˆåˆ›å»ºIssueæƒé™

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 1

      - name: ğŸ é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"  # ç¼“å­˜pipä¾èµ–åŠ é€Ÿå®‰è£…

      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests tenacity

      - name: ğŸ¬ å®‰è£…ffmpegï¼ˆç”¨äºæµæ£€æµ‹ï¼‰
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg
          ffmpeg -version  # éªŒè¯å®‰è£…

      - name: ğŸš€ è¿è¡Œçˆ¬å–è„šæœ¬
        run: python fofa_fetch.py
        env:
          PYTHONUNBUFFERED: "1"  # å®æ—¶è¾“å‡ºæ—¥å¿—
        timeout-minutes: 25      # è„šæœ¬è¿è¡Œè¶…æ—¶é™åˆ¶

      - name: âŒ å¤±è´¥é€šçŸ¥ï¼ˆåˆ›å»ºIssueï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // åˆ›å»ºå¤±è´¥é€šçŸ¥Issue
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `IPTVæ›´æ–°ä»»åŠ¡å¤±è´¥ [${new Date().toISOString().slice(0, 19).replace('T', ' ')}]`,
              body: `
## ä»»åŠ¡å¤±è´¥é€šçŸ¥
- è§¦å‘æ—¶é—´ï¼š${new Date().toISOString()}
- å·¥ä½œæµï¼š${context.workflow}
- è¿è¡ŒIDï¼š${context.runId}

è¯·å‰å¾€ [Actionsé¡µé¢](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼
              `,
              labels: ["bug", "auto-generated"]
            })
