name: FOFA IPTV è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: "0 */1 * * *"  # é™ä½é¢‘ç‡ï¼ˆæ¯1å°æ—¶ï¼‰ï¼Œé¿å…GitHubé™æµ
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      actions: read

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç åº“ï¼ˆå«å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0  # å¿…é¡»æ‹‰å–å®Œæ•´å†å²ï¼Œå¦åˆ™gitæ¨é€å¤±è´¥

      - name: ğŸ é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "./requirements.txt"  # æŒ‡å®šä¾èµ–æ–‡ä»¶è·¯å¾„

      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip list | grep -E "requests|tenacity"  # éªŒè¯å®‰è£…

      - name: ğŸ¬ å¼ºåˆ¶å®‰è£…ffmpegï¼ˆè§£å†³å®‰è£…å¤±è´¥ï¼‰
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --force-yes ffmpeg
          ffmpeg -version
          ffprobe -version

      - name: ğŸ› ï¸ é…ç½®Gitï¼ˆè§£å†³æ¨é€æƒé™ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸš€ è¿è¡Œçˆ¬å–è„šæœ¬
        run: python fofa_fetch.py
        env:
          PYTHONUNBUFFERED: "1"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # è‡ªåŠ¨æ³¨å…¥çš„ä»¤ç‰Œ
        timeout-minutes: 25

      - name: âŒ å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const timeStr = now.toISOString().slice(0, 19).replace('T', ' ');
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `IPTVæ›´æ–°å¤±è´¥ [${timeStr}]`,
              body: `## å¤±è´¥è¯¦æƒ…
- è¿è¡ŒIDï¼š${context.runId}
- å·¥ä½œæµï¼š${context.workflow}
- è§¦å‘æ—¶é—´ï¼š${now.toISOString()}

[æŸ¥çœ‹å®Œæ•´æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ["auto-failure"]
            })
