name: FOFA IPTV è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: "*/15 * * * *"  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30     # æœ€å¤§è¿è¡Œæ—¶é•¿é™åˆ¶
    permissions:
      contents: write       # æˆäºˆå†™å…¥ä»£ç åº“æƒé™
      issues: write         # æˆäºˆåˆ›å»ºIssueæƒé™

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 1

      - name: ğŸ é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          # ç¦ç”¨è‡ªåŠ¨ä¾èµ–ç¼“å­˜æ£€æµ‹ï¼ˆè§£å†³requirements.txtå‘Šè­¦ï¼‰
          cache-dependency-path: "none"

      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests tenacity
          # éªŒè¯ä¾èµ–å®‰è£…
          pip list | grep -E "requests|tenacity"

      - name: ğŸ¬ å®‰è£…ffmpegï¼ˆç”¨äºæµæ£€æµ‹ï¼‰
        run: |
          sudo apt-get update -y && sudo apt-get install -y ffmpeg
          # éªŒè¯ffmpeg/ffprobeå®‰è£…
          ffmpeg -version
          ffprobe -version

      - name: ğŸ“ åˆ›å»ºç©ºçš„requirements.txtï¼ˆå½»åº•æ¶ˆé™¤å‘Šè­¦ï¼‰
        run: touch requirements.txt

      - name: ğŸš€ è¿è¡Œçˆ¬å–è„šæœ¬
        run: python fofa_fetch.py
        env:
          PYTHONUNBUFFERED: "1"  # å®æ—¶è¾“å‡ºæ—¥å¿—
        timeout-minutes: 25      # è„šæœ¬è¿è¡Œè¶…æ—¶é™åˆ¶

      - name: âŒ å¤±è´¥é€šçŸ¥ï¼ˆåˆ›å»ºIssueï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const timeStr = now.toISOString().slice(0, 19).replace('T', ' ');
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `IPTVæ›´æ–°ä»»åŠ¡å¤±è´¥ [${timeStr}]`,
              body: `## ä»»åŠ¡å¤±è´¥é€šçŸ¥\n- è§¦å‘æ—¶é—´ï¼š${now.toISOString()}\n- å·¥ä½œæµï¼š${context.workflow}\n- è¿è¡ŒIDï¼š${context.runId}\n\nè¯·å‰å¾€ [Actionsé¡µé¢](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼`,
              labels: ["bug", "auto-generated"]
            })

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: rm -f requirements.txt
